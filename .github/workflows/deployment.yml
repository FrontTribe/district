name: Deploy District Project

on:
  push:
    branches: [main, development]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Test SSH Connection
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_PASS: ${{ secrets.SERVER_PASS }}
        run: sshpass -p "$SERVER_PASS" ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" "echo Connected to server"

      - name: Deploy to Server
        env:
          BRANCH_NAME: ${{ github.ref_name }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_PASS: ${{ secrets.SERVER_PASS }}
          SERVER_PORT: ${{ secrets.SERVER_PORT }}
        run: |
          set -euo pipefail
          DEPLOY_PORT="${SERVER_PORT:-22}"

          if [ "$BRANCH_NAME" = "main" ]; then
            DEPLOY_PATH="/var/www/district-prod"
            APP_NAME="district-prod"
            APP_PORT="3000"
            NODE_ENV="production"
            RUN_CMD="start"
          elif [ "$BRANCH_NAME" = "development" ]; then
            DEPLOY_PATH="/var/www/district-dev"
            APP_NAME="district-dev"
            APP_PORT="3001"
            NODE_ENV="development"
            RUN_CMD="dev"
          else
            echo "No deploy target for branch $BRANCH_NAME"
            exit 0
          fi

          TARBALL="$(mktemp -t district-deploy-XXXXXX.tgz)"
          cleanup() { rm -f "$TARBALL"; }
          trap cleanup EXIT

          tar -czf "$TARBALL" \
            --exclude='./.git' \
            --exclude='./.next' \
            --exclude='./node_modules' \
            --exclude='./.env' \
            --exclude='./.env.*' \
            --exclude='./coverage' \
            --exclude='./playwright-report' \
            --exclude='./test-results' \
            -C "$GITHUB_WORKSPACE" .

          REMOTE_TARBALL="/tmp/${APP_NAME}.tgz"
          sshpass -p "$SERVER_PASS" scp -P "$DEPLOY_PORT" -o StrictHostKeyChecking=no \
            "$TARBALL" "$SERVER_USER@$SERVER_HOST:$REMOTE_TARBALL"

          sshpass -p "$SERVER_PASS" ssh -p "$DEPLOY_PORT" -o StrictHostKeyChecking=no \
            "$SERVER_USER@$SERVER_HOST" \
            "DEPLOY_PATH='$DEPLOY_PATH' APP_NAME='$APP_NAME' REMOTE_TARBALL='$REMOTE_TARBALL' APP_PORT='$APP_PORT' NODE_ENV='$NODE_ENV' RUN_CMD='$RUN_CMD' DEPLOY_USER='$SERVER_USER' SUDO_PASS='$SERVER_PASS' bash -s" <<'REMOTE'
          set -euo pipefail

          DEPLOY_PATH="${DEPLOY_PATH:?}"
          APP_NAME="${APP_NAME:?}"
          REMOTE_TARBALL="${REMOTE_TARBALL:?}"
          APP_PORT="${APP_PORT:?}"
          NODE_ENV="${NODE_ENV:?}"
          RUN_CMD="${RUN_CMD:?}"
          DEPLOY_USER="${DEPLOY_USER:?}"
          SUDO_PASS="${SUDO_PASS:-}"

          cleanup() { rm -f "$REMOTE_TARBALL"; }
          trap cleanup EXIT

          if ! mkdir -p "$DEPLOY_PATH" 2>/dev/null; then
            if [ -n "$SUDO_PASS" ]; then
              echo "$SUDO_PASS" | sudo -S mkdir -p "$DEPLOY_PATH"
            else
              echo "Unable to create $DEPLOY_PATH. Check permissions or provide sudo access."
              exit 1
            fi
          fi

          if [ ! -w "$DEPLOY_PATH" ]; then
            if [ -n "$SUDO_PASS" ]; then
              echo "$SUDO_PASS" | sudo -S chown -R "$DEPLOY_USER":"$DEPLOY_USER" "$DEPLOY_PATH"
            else
              echo "No write permission for $DEPLOY_PATH. Check ownership or provide sudo access."
              exit 1
            fi
          fi

          tar -xzf "$REMOTE_TARBALL" -C "$DEPLOY_PATH" --no-same-owner --no-same-permissions

          cd "$DEPLOY_PATH"

          if ! command -v pnpm >/dev/null 2>&1; then
            if command -v corepack >/dev/null 2>&1; then
              corepack enable
            else
              echo "pnpm not found and corepack not available. Install pnpm on the server."
              exit 1
            fi
          fi

          if ! command -v pm2 >/dev/null 2>&1; then
            npm install -g pm2
          fi

          pnpm install --frozen-lockfile

          if [ "$NODE_ENV" = "production" ]; then
            pnpm build
          fi

          pm2 delete "$APP_NAME" >/dev/null 2>&1 || true
          PORT="$APP_PORT" NODE_ENV="$NODE_ENV" pm2 start pnpm --name "$APP_NAME" -- "$RUN_CMD"

          sleep 2
          PID="$(pm2 pid "$APP_NAME" | head -n 1 | tr -d '[:space:]')"
          if [ -z "$PID" ] || [ "$PID" = "0" ]; then
            echo "PM2 process failed to stay online. Showing recent logs:"
            pm2 logs "$APP_NAME" --lines 50 || true
            exit 1
          fi

          pm2 save
          REMOTE
