name: Deploy District Project

on:
  push:
    branches: [main, development]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ðŸ§© Step 1: Checkout the repository
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      # ðŸ” Step 2: Setup SSH key for server connection
      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # âš™ï¸ Step 3: Setup PNPM
      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 10.11.0

      # ðŸ§  Step 4: Test SSH connection
      - name: Test SSH
        run: ssh -o StrictHostKeyChecking=no deployer@${{ secrets.SERVER_IP }} "echo âœ… Connected to server"

      # ðŸš€ Step 5: Deploy project (runs in background to prevent timeout)
      - name: Deploy
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          if [ "$BRANCH_NAME" = "main" ]; then
            ssh -o StrictHostKeyChecking=no deployer@${{ secrets.SERVER_IP }} "
              cd /var/www/district-prod &&
              nohup bash -c '
                echo \"ðŸŒ€ Starting main branch deployment...\" &&
                git fetch origin main &&
                git reset --hard origin/main &&
                pnpm i --frozen-lockfile --silent &&
                pnpm run build --silent &&
                pm2 restart district-prod &&
                echo \"âœ… Deployment completed successfully.\"
              ' > ~/deploy-district-prod.log 2>&1 &
              echo 'ðŸš€ Build started in background for main branch. Check logs: ~/deploy-district-prod.log'
            "
          elif [ "$BRANCH_NAME" = "development" ]; then
            ssh -o StrictHostKeyChecking=no deployer@${{ secrets.SERVER_IP }} "
              cd /var/www/district-dev &&
              nohup bash -c '
                echo \"ðŸŒ€ Starting development branch deployment...\" &&
                git fetch origin development &&
                git reset --hard origin/development &&
                pnpm i --frozen-lockfile --silent &&
                pnpm run build --silent &&
                pm2 restart district-dev &&
                echo \"âœ… Deployment completed successfully.\"
              ' > ~/deploy-district-dev.log 2>&1 &
              echo 'ðŸš€ Build started in background for development branch. Check logs: ~/deploy-district-dev.log'
            "
          fi
