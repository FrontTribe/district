name: Deploy District Project

on:
  push:
    branches: [main, development]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ğŸ§© Step 1: Checkout the repository
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      # ğŸ” Step 2: Setup SSH key to connect to your server
      - name: Setup SSH Key for Server
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # ğŸ§  Step 3: Setup PNPM (use same version as package.json)
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.11.0

      # âš¡ Optional: Cache node_modules to speed up CI (local build only)
      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      # ğŸ”— Step 4: Test SSH connection (to ensure deployment will work)
      - name: Test SSH Connection
        run: ssh -o StrictHostKeyChecking=no deployer@${{ secrets.SERVER_IP }} "echo âœ… Connected to server"

      # ğŸš€ Step 5: Deploy based on branch (main â†’ prod, development â†’ dev)
      - name: Deploy to Server
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          if [ "$BRANCH_NAME" = "main" ]; then
            echo "ğŸš€ Deploying to Production..."
            ssh -o StrictHostKeyChecking=no deployer@${{ secrets.SERVER_IP }} "
              set -e
              cd /var/www/district-prod
              git fetch origin main
              git reset --hard origin/main
              pnpm install --frozen-lockfile
              pnpm run build
              pm2 restart district-prod
            "
          elif [ "$BRANCH_NAME" = "development" ]; then
            echo "ğŸš§ Deploying to Development..."
            ssh -o StrictHostKeyChecking=no deployer@${{ secrets.SERVER_IP }} "
              set -e
              cd /var/www/district-dev
              git fetch origin development
              git reset --hard origin/development
              pnpm install --frozen-lockfile
              pnpm run build
              pm2 restart district-dev
            "
          else
            echo "âŒ Unknown branch: $BRANCH_NAME"
            exit 1
          fi
