name: Deploy District Project

on:
  push:
    branches: [main, development]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # üß© Step 1: Checkout the repository
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      # üîê Step 2: Setup SSH key for server connection
      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # ‚öôÔ∏è Step 3: Setup PNPM
      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 10.11.0

      # üß† Step 4: Test SSH connection
      - name: Test SSH
        run: ssh -o StrictHostKeyChecking=no deployer@${{ secrets.SERVER_IP }} "echo ‚úÖ Connected to server"

      # üöÄ Step 5: Deploy project (fails fast and runs inline for better logs)
      - name: Deploy
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          if [ "$BRANCH_NAME" = "main" ]; then
            REMOTE_DIR="/var/www/district-prod"
            REMOTE_SERVICE="district-prod"
            LOG_LABEL="production"
          elif [ "$BRANCH_NAME" = "development" ]; then
            REMOTE_DIR="/var/www/district-dev"
            REMOTE_SERVICE="district-dev"
            LOG_LABEL="development"
          else
            echo "‚ö†Ô∏è  Deployment skipped: branch $BRANCH_NAME is not configured."
            exit 0
          fi

          echo "üöÄ Starting $LOG_LABEL deployment for branch $BRANCH_NAME"

          ssh -o StrictHostKeyChecking=no deployer@${{ secrets.SERVER_IP }} <<EOF
set -euo pipefail

cd "$REMOTE_DIR"
echo "‚ÑπÔ∏è  Updating repository in \$PWD"
git fetch origin "$BRANCH_NAME"
git reset --hard "origin/$BRANCH_NAME"

echo "‚ÑπÔ∏è  Installing dependencies"
pnpm install --frozen-lockfile --silent

echo "‚ÑπÔ∏è  Building application"
pnpm run build --silent

echo "üîÅ Restarting $REMOTE_SERVICE via pm2"
pm2 restart "$REMOTE_SERVICE"

echo "‚úÖ Deployment completed for branch $BRANCH_NAME"
EOF
